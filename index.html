<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lye, Dye, and DIY — Bel Lei’s Soap Calculator (v0.7)</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" sizes="192x192" href="icons/icon-192.png">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="theme-color" content="#98273B">
<style>
:root{
  --brand:#98273B; --brand2:#F7707E; --olive:#7F894B;
  --ink:#222; --muted:#6b7280; --bg:#fff8f8; --panel:#ffffff;
  --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
  --ring:0 0 0 3px rgba(152,39,59,.18);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
header{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:18px 14px}
h1{margin:0 0 4px;font-size:26px;letter-spacing:.3px}
.small{opacity:.9;font-size:13px}
.container{max-width:1100px;margin:14px auto;padding:0 12px}
.card{background:var(--panel);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:14px}
.grid{display:grid;gap:12px}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 12px}
.btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.subtle{background:#fff;border:1px solid #e5e7eb;color:var(--ink)}
.btn.alt{background:var(--olive);color:#fff}
.btn:focus{outline:none;box-shadow:var(--ring)}
.tabbar{display:flex;gap:8px;flex-wrap:wrap}
.tab{background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:8px 12px;cursor:pointer}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
input,select,textarea{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
label{font-weight:700;font-size:14px;margin-bottom:6px;display:block}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.badge{display:inline-flex;align-items:center;gap:6px;font-weight:700;padding:6px 10px;border-radius:999px;font-size:12px}
.b-ok{background:#ecfdf5;color:#065f46}
.b-warn{background:#fffbeb;color:#92400e}
.b-danger{background:#fef2f2;color:#991b1b}
.note{font-size:13px;color:var(--muted)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:14px;vertical-align:top}
.kpi{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
.kpi > div{background:#f9fafb;border:1px solid #eef2f7;border-radius:10px;padding:8px 10px;font-size:13px}
.section-title{display:flex;align-items:center;justify-content:space-between;margin:6px 0 8px}
.tag{background:#fff;border:1px solid #e5e7eb;padding:5px 8px;border-radius:8px;font-size:12px}
fieldset{border:none;margin:0;padding:0}
legend{font-weight:800;margin-bottom:6px}
.hide{display:none!important}
.stickyCalc{position:sticky;bottom:10px;z-index:5}
.table-sm th,.table-sm td{padding:6px}
hr{border:none;border-top:1px solid #eee;margin:8px 0}
@media (max-width:820px){
  .row,.row3{grid-template-columns:1fr}
  header{padding:16px 12px}
  h1{font-size:22px}
}
@media print{
  header,.tabbar,.controls .btn,#installBtn{display:none!important}
  body{background:#fff}
  .card{box-shadow:none;border:1px solid #ddd}
}
</style>
</head>
<body>
<header>
  <h1>Lye, Dye, and DIY</h1>
  <div class="small">Bel Lei’s Soaps N Stuffs • Beginner-friendly, pro-accurate calculator (v0.7)</div>
</header>

<div class="container grid">

  <!-- tabs -->
  <div class="tabbar" role="tablist" aria-label="sections">
    <div class="tab active" data-tab="calc">Calculator</div>
    <div class="tab" data-tab="lyelimited">Lye-Limited</div>
    <div class="tab" data-tab="design">Design Planner</div>
    <div class="tab" data-tab="molds">Mold Library</div>
    <div class="tab" data-tab="inventory">Inventory</div>
    <div class="tab" data-tab="labels">Labels / INCI</div>
    <div class="tab" data-tab="cost">Cost & Profit</div>
    <div class="tab" data-tab="save">Save / Load</div>
    <div class="tab" data-tab="guide">Guide Mode</div>
    <div class="tab" data-tab="feedback">Feedback</div>
    <div class="tab" data-tab="install"><span id="installLabel">Install App</span></div>
  </div>

  <!-- CALCULATOR -->
  <section class="card grid" id="calc" role="tabpanel" aria-labelledby="calc-tab">
    <div class="section-title">
      <h2 style="margin:0">Calculator</h2>
      <span class="tag" id="modeTag">Quick Mode</span>
    </div>

    <div class="row">
      <div>
        <label for="targetOils">Desired total oils (<span id="uLabel">g</span>)</label>
        <input id="targetOils" type="number" inputmode="decimal" value="1000">
        <div class="note">Tip: Enter 750 • 1000 • 1400. <b>Units:</b> <a href="#" id="unitToggle">grams</a> / ounces</div>
      </div>
      <div>
        <label for="profile">Recipe profile</label>
        <select id="profile">
          <option value="PF45-30-15-10">Palm-Free Balanced (45/30/15/10)</option>
          <option value="hard40">Hard & long-lasting (Lard/OO)</option>
          <option value="bubbles">Bubbly (higher Coconut/Castor)</option>
        </select>
        <div class="controls">
          <button class="btn subtle" id="applyBtn">Apply profile</button>
          <button class="btn subtle" id="scaleBtn">Scale to target</button>
          <button class="btn subtle" id="pctBtn">Percent mode: Off</button>
        </div>
      </div>
    </div>

    <fieldset>
      <legend>Oils & Butters</legend>
      <table class="table" id="oilTable">
        <thead><tr><th>Oil</th><th style="width:170px"><span id="wtHdr">Weight (g)</span></th><th></th></tr></thead>
        <tbody id="oilBody"></tbody>
      </table>
      <div class="controls">
        <button class="btn subtle" id="addOil">+ Add oil</button>
        <span class="kpi" id="oilTotals"></span>
      </div>
    </fieldset>

    <fieldset class="grid">
      <legend>Lye & Water</legend>
      <div class="row3">
        <div>
          <label for="lyeType">Lye type</label>
          <select id="lyeType">
            <option value="NaOH">NaOH (bar soap)</option>
            <option value="KOH">KOH (liquid soap)</option>
            <option value="dual">Dual-lye (split)</option>
          </select>
        </div>
        <div>
          <label for="lyePurity">NaOH purity (%)</label>
          <input id="lyePurity" type="number" value="100">
        </div>
        <div>
          <label for="kohPurity">KOH purity (%)</label>
          <input id="kohPurity" type="number" value="90">
        </div>
      </div>

      <div class="row3" id="dualBox" class="hide">
        <div>
          <label for="dualPct">Dual-lye: % as NaOH (rest KOH)</label>
          <input id="dualPct" type="number" value="90">
        </div>
        <div>
          <label for="superfat">Superfat / Lye discount (%)</label>
          <input id="superfat" type="number" value="5">
        </div>
        <div class="note" style="align-self:end">Beginner tip: 3–8% is common.</div>
      </div>

      <div class="row3">
        <div>
          <label for="waterMode">Water mode</label>
          <select id="waterMode">
            <option value="ratio">Water : Lye ratio</option>
            <option value="pctOil">Water % of oils</option>
            <option value="pctSoln">Lye solution % (conc)</option>
            <option value="master">Master-batch lye (%)</option>
          </select>
        </div>
        <div>
          <label for="waterParam" id="waterParamLbl">Water : Lye</label>
          <input id="waterParam" type="number" step="0.05" value="2.5">
        </div>
        <div>
          <label for="milkPct">Milk replacement (% of liquid)</label>
          <input id="milkPct" type="number" value="0">
          <div class="note">Freeze slushy; keep solution cool to avoid scorching.</div>
        </div>
      </div>

      <div class="row3">
        <div>
          <label for="potMl">Pot / Crockpot capacity (mL)</label>
          <input id="potMl" type="number" value="5678">
        </div>
        <div>
          <label for="moldPreset">Mold helper</label>
          <select id="moldPreset">
            <option value="">— choose —</option>
            <option value="loaf">Loaf (L×W×H cm)</option>
            <option value="cavity">Cavity (mL × count)</option>
            <option value="slab">Slab (L×W×H cm)</option>
          </select>
        </div>
        <div class="note" style="align-self:end">Safe headroom: usually 60–75% fill.</div>
      </div>

      <div id="moldInputs" class="row3 hide">
        <div><label>L (cm)</label><input id="mL" type="number"></div>
        <div><label>W (cm)</label><input id="mW" type="number"></div>
        <div><label>H (cm)</label><input id="mH" type="number"></div>
        <div><label>Cavity mL</label><input id="cavMl" type="number"></div>
        <div><label>Cavities</label><input id="cavCount" type="number"></div>
        <div style="align-self:end"><button class="btn subtle" id="moldEstimate">Estimate oils from mold</button></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Additives (% of oils unless noted)</legend>
      <div class="row3">
        <div>
          <label for="foType">Fragrance / EO type</label>
          <select id="foType">
            <option value="FO">Fragrance Oil (general)</option>
            <option value="EO-Peppermint">Peppermint EO</option>
            <option value="EO-Lavender">Lavender EO</option>
            <option value="EO-CinnamonBark">Cinnamon Bark EO</option>
            <option value="EO-CloveBud">Clove Bud EO</option>
          </select>
        </div>
        <div>
          <label for="fragPct">Fragrance / EO %</label>
          <input id="fragPct" type="number" value="3" step="0.1">
        </div>
        <div class="note" style="align-self:end" id="foNote"></div>
      </div>
      <div class="row3">
        <div><label for="slPct">Sodium Lactate % (in water)</label><input id="slPct" type="number" value="0" placeholder="1–3"></div>
        <div><label for="saltPct">Salt %</label><input id="saltPct" type="number" value="0" placeholder="0–3"></div>
        <div><label for="sugarPct">Sugar %</label><input id="sugarPct" type="number" value="0" placeholder="0–3"></div>
      </div>
      <div class="row3">
        <div><label for="clayPct">Clay %</label><input id="clayPct" type="number" value="0" placeholder="0–2"></div>
        <div><label for="chelPct">EDTA/Citrate %</label><input id="chelPct" type="number" value="0.3" step="0.1"></div>
        <div></div>
      </div>
      <div class="kpi" id="additiveBadges"></div>
    </fieldset>

    <div class="controls stickyCalc">
      <button class="btn" id="calcBtn">Calculate</button>
      <button class="btn subtle" id="printBtn">Print</button>
      <button class="btn subtle" id="exportBtn">Export JSON</button>
      <button class="btn alt hide" id="installBtn">Install App</button>
    </div>

    <section class="card" id="results" style="border:1px dashed #eee">
      <h3 style="margin:6px 0 10px">Batch Results</h3>
      <div class="grid">
        <table class="table" id="resTable"></table>
        <div class="kpi" id="safetyBadges"></div>
      </div>
    </section>
  </section>

  <!-- LYE-LIMITED -->
  <section class="card grid hide" id="lyelimited" role="tabpanel">
    <h2 style="margin:0">Lye-Limited Mode</h2>
    <div class="row3">
      <div><label for="availLye">How much NaOH (g) do you have?</label><input id="availLye" type="number" value="200"></div>
      <div><label for="sfLL">Superfat (%)</label><input id="sfLL" type="number" value="5"></div>
      <div><label for="ratioLL">Water : Lye</label><input id="ratioLL" type="number" value="2.5" step="0.05"></div>
    </div>
    <div class="note">Pick a profile; we’ll auto-proportion oils to the maximum safe total from your available lye.</div>
    <div class="row">
      <div>
        <label for="profileLL">Profile</label>
        <select id="profileLL">
          <option value="PF45-30-15-10">Palm-Free Balanced</option>
          <option value="hard40">Hard & long-lasting</option>
          <option value="bubbles">Bubbly</option>
        </select>
      </div>
      <div style="align-self:end"><button class="btn" id="llBtn">Calculate from lye</button></div>
    </div>
    <table class="table" id="llRes"></table>
  </section>

  <!-- DESIGN PLANNER -->
  <section class="card grid hide" id="design" role="tabpanel">
    <h2 style="margin:0">Design Planner</h2>
    <div class="row3">
      <div>
        <label for="designType">Design</label>
        <select id="designType">
          <option value="layers">Layers</option>
          <option value="itp">In-the-Pot Swirl</option>
          <option value="hanger">Hanger Swirl</option>
        </select>
      </div>
      <div><label for="designParts">Parts/Layers</label><input id="designParts" type="number" value="3"></div>
      <div><label for="restMinutes">Rest between pours (min)</label><input id="restMinutes" type="number" value="5"></div>
    </div>
    <div class="note">After you Calculate in the main tab, come here to split the batter by design.</div>
    <div class="controls">
      <button class="btn subtle" id="designSplit">Split batter now</button>
    </div>
    <table class="table table-sm" id="designTable"></table>
  </section>

  <!-- MOLD LIBRARY -->
  <section class="card grid hide" id="molds" role="tabpanel">
    <h2 style="margin:0">Mold Library</h2>
    <div class="row3">
      <div><label>Name</label><input id="mName" placeholder="e.g., 10\" Loaf (2.5×3.5×10 in)"></div>
      <div>
        <label>Type</label>
        <select id="mType">
          <option value="loaf">Loaf (L×W×H cm)</option>
          <option value="slab">Slab (L×W×H cm)</option>
          <option value="cavity">Cavity (mL × count)</option>
        </select>
      </div>
      <div><label>Notes (optional)</label><input id="mNotes" placeholder="silicone liner, tall/skinny, etc."></div>
    </div>
    <div class="row3">
      <div><label>L (cm) or Cavity mL</label><input id="mLibL" type="number" placeholder="L or cavity mL"></div>
      <div><label>W (cm) or Cavities</label><input id="mLibW" type="number"></div>
      <div><label>H (cm)</label><input id="mLibH" type="number"></div>
    </div>
    <div class="controls">
      <button class="btn" id="mAdd">Save mold</button>
      <button class="btn subtle" id="mList">Refresh list</button>
    </div>
    <table class="table" id="mListTable"></table>
  </section>

  <!-- INVENTORY -->
  <section class="card grid hide" id="inventory" role="tabpanel">
    <h2 style="margin:0">Inventory</h2>
    <p class="note">Track on-hand grams for oils, lye, and additives. After you calculate, we’ll warn if anything is short. Optionally deduct when you save.</p>
    <div class="controls"><button class="btn subtle" id="invLoadFromRecipe">Add current recipe items</button></div>
    <table class="table" id="invTable"></table>
    <div class="controls">
      <button class="btn" id="invSave">Save Inventory</button>
      <label style="display:flex;align-items:center;gap:8px"><input id="invAutoDeduct" type="checkbox"> Deduct on Save Recipe</label>
    </div>
    <div class="kpi" id="invStatus"></div>
  </section>

  <!-- LABELS / INCI -->
  <section class="card grid hide" id="labels" role="tabpanel">
    <h2 style="margin:0">Labels / INCI</h2>
    <p class="note">Generated from your current recipe (oils order by prominence). Always verify local regulations.</p>
    <div class="controls">
      <button class="btn subtle" id="labelGen">Generate from recipe</button>
      <button class="btn subtle" id="labelPrint">Print label sheet</button>
    </div>
    <table class="table" id="inciTable"></table>
  </section>

  <!-- COST -->
  <section class="card grid hide" id="cost" role="tabpanel">
    <h2 style="margin:0">Cost & Profit</h2>
    <div id="costWrap" class="grid"></div>
    <div class="row3">
      <div><label>Bars per loaf</label><input id="barsCount" type="number" value="10"></div>
      <div><label>Target price per bar ($)</label><input id="priceBar" type="number" value="6" step="0.1"></div>
      <div style="align-self:end"><button class="btn subtle" id="costBtn">Update costs</button></div>
    </div>
    <div class="kpi" id="costSummary"></div>
  </section>

  <!-- SAVE/LOAD -->
  <section class="card grid hide" id="save" role="tabpanel">
    <h2 style="margin:0">Save / Load</h2>
    <div class="row">
      <div><label>Recipe name</label><input id="recName" placeholder="e.g., Charcoal Mint CP"></div>
      <div style="align-self:end" class="controls">
        <button class="btn" id="saveBtn">Save</button>
        <button class="btn subtle" id="loadBtn">Load</button>
        <button class="btn subtle" id="listBtn">List</button>
        <button class="btn subtle" id="delBtn">Delete</button>
      </div>
    </div>
    <div id="saveList" class="kpi"></div>
  </section>

  <!-- GUIDE MODE -->
  <section class="card grid hide" id="guide" role="tabpanel">
    <h2 style="margin:0">Guide Mode (Step-by-Step)</h2>
    <p class="note">Uses your current calculation to produce exact steps and timers.</p>
    <div class="controls"><button class="btn" id="guideBuild">Build Guide from current recipe</button></div>
    <ol id="guideSteps"></ol>
  </section>

  <!-- FEEDBACK -->
  <section class="card grid hide" id="feedback" role="tabpanel">
    <h2 style="margin:0">Feedback</h2>
    <p class="note">Beta testers: write notes and include Export JSON so we can replay your inputs.</p>
    <textarea id="fb" rows="6" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px"></textarea>
    <div class="controls"><button class="btn subtle" id="fbSave">Save note</button></div>
  </section>

</div>

<script>
/* ========= DATA ========= */
const SAP_NaOH = {
  "Olive Oil (pure)":0.134, "Coconut Oil 76°":0.183, "Avocado Oil":0.133,
  "Lard":0.141, "Shea Butter (raw)":0.128, "Castor Oil":0.128
};
const INCI = {
  "Olive Oil (pure)":"Olea Europaea (Olive) Oil",
  "Coconut Oil 76°":"Cocos Nucifera (Coconut) Oil",
  "Avocado Oil":"Persea Gratissima (Avocado) Oil",
  "Lard":"Lard (Pig Fat)",
  "Shea Butter (raw)":"Butyrospermum Parkii (Shea) Butter",
  "Castor Oil":"Ricinus Communis (Castor) Seed Oil",
  "Water":"Aqua",
  "Sodium Hydroxide":"Sodium Hydroxide",
  "Fragrance":"Parfum",
  "Essential Oil":"Essential Oil",
  "Activated Charcoal":"Charcoal Powder",
  "Kaolin":"Kaolin",
  "Sodium Lactate":"Sodium Lactate",
  "EDTA/Citrate":"Sodium Citrate / Tetrasodium EDTA",
  "Salt":"Sodium Chloride",
  "Sugar":"Sucrose",
  "Clay":"Kaolin/Illite (Clay)"
};
const OILS = Object.keys(SAP_NaOH);
const KOH_FACTOR = 1.403;
const defaults = {
  oils: [["Olive Oil (pure)",450],["Coconut Oil 76°",300],["Lard",150],["Shea Butter (raw)",70],["Castor Oil",30]],
  potMl:5678
};
const additivesSpec = {
  frag:{min:0,max:4.5}, sl:{min:1,max:3}, salt:{min:0,max:3},
  sugar:{min:0,max:3}, clay:{min:0,max:2}, chel:{min:0,max:0.5}
};
const FO_RULES = {
  "FO":{max:4.5, tip:"Most FOs 2–4.5%. Check supplier notes."},
  "EO-Peppermint":{max:3.0, tip:"Cool; 1.5–3% typical."},
  "EO-Lavender":{max:4.0, tip:"Gentle; 2–4% typical."},
  "EO-CinnamonBark":{max:0.5, tip:"Dermal max is very low. Use care."},
  "EO-CloveBud":{max:0.5, tip:"Hot EO; use sparingly."}
};
let percentMode=false, useOz=false;

/* ========= HELPERS ========= */
const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);
function oz(n){return n/28.349523125}
function g(n){return n*28.349523125}
function unitLabel(){ $("#uLabel").textContent = useOz?'oz':'g'; $("#wtHdr").textContent = `Weight (${useOz?'oz':'g'})`; }
function valToDisplay(n){ return useOz ? oz(n) : n; }
function parseByUnit(v){ const n=parseFloat(v)||0; return useOz ? g(n) : n; }
function badge(level,text){const c=level==="ok"?"b-ok":level==="warn"?"b-warn":"b-danger";return `<span class="badge ${c}">${text}</span>`;}
function sum(a){return a.reduce((s,x)=>s+x,0)}
function cssId(n){return n.replace(/[^a-z0-9]/gi,'_')}
function debounce(fn,ms=140){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);}}

/* ========= OILS TABLE ========= */
function oilRows(){return [...$("#oilBody").children].map(tr=>[tr.querySelector("select").value, parseFloat(tr.querySelector("input").value||0)])}
function oilsAsGrams(){
  const rows=oilRows();
  if(!percentMode) return rows.map(([n,v])=>[n,parseByUnit(v)]);
  const target=parseByUnit($("#targetOils").value||0);
  return rows.map(([n,p])=>[n, target*((+p||0)/100)]);
}
function addOilRow(name="",val=0){
  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td><select>${OILS.map(k=>`<option ${k===name?'selected':''}>${k}</option>`).join('')}</select></td>
    <td><input type="number" inputmode="decimal" value="${val?(percentMode?val:(useOz?oz(val).toFixed(2):val)):''}"></td>
    <td><button class="btn subtle" type="button">Remove</button></td>`;
  tr.querySelector("button").addEventListener('click',()=>{tr.remove();liveUpdate();});
  $("#oilBody").appendChild(tr);
}
function updateOilTotals(){const rows=oilsAsGrams();const tot=sum(rows.map(r=>r[1]||0));$("#oilTotals").innerHTML=`<div>Total oils: <b>${tot.toFixed(1)} g</b> (${oz(tot).toFixed(2)} oz)</div>`}

/* ========= PROFILES / SCALING ========= */
function profilePercents(k){
  if(k==="hard40")return [["Olive Oil (pure)",40],["Lard",40],["Coconut Oil 76°",15],["Castor Oil",5]];
  if(k==="bubbles")return [["Olive Oil (pure)",35],["Coconut Oil 76°",35],["Lard",20],["Castor Oil",10]];
  return [["Olive Oil (pure)",45],["Coconut Oil 76°",30],["Lard",15],["Shea Butter (raw)",10]];
}
function applyProfile(){
  const tgtG=parseByUnit($("#targetOils").value||0), plan=profilePercents($("#profile").value);
  $("#oilBody").innerHTML="";
  if(percentMode){plan.forEach(([n,p])=>addOilRow(n,p));}
  else{let used=0;plan.forEach(([n,p],i)=>{const grams=i===plan.length-1?(tgtG-used):Math.round(tgtG*p/100);used+=grams;addOilRow(n,grams);});}
  updateOilTotals();calculate();
}
function togglePctMode(){
  percentMode=!percentMode;$("#pctBtn").textContent=`Percent mode: ${percentMode?'On':'Off'}`;
  $("#wtHdr").textContent=percentMode?"Percent (%)":`Weight (${useOz?'oz':'g'})`;
  const rows=oilsAsGrams();$("#oilBody").innerHTML="";
  if(percentMode){const tot=sum(rows.map(r=>r[1]||0))||parseByUnit($("#targetOils").value||0);rows.forEach(([n,g])=>addOilRow(n, tot?(g/tot*100).toFixed(2):0));}
  else{rows.forEach(([n,g])=>addOilRow(n,g));}
  updateOilTotals();calculate();
}
function scaleToTarget(){
  const tgt=parseByUnit($("#targetOils").value||0);let rows=oilsAsGrams();
  if(percentMode){
    const totalPct=sum(oilRows().map(r=>+r[1]||0))||100;
    rows=oilRows().map(([n,p],i)=>[n, i===oilRows().length-1?(tgt - sum(oilRows().slice(0,-1).map(([n2,p2])=>Math.round(tgt*(p2/totalPct))))):Math.round(tgt*(p/totalPct))]);
  }else{const cur=sum(rows.map(r=>r[1]||0))||1;rows=rows.map(([n,g])=>[n,g*tgt/cur]);}
  $("#oilBody").innerHTML="";rows.forEach(([n,g])=>addOilRow(n,g));updateOilTotals();calculate();
}

/* ========= LYE / WATER / ADDITIVES ========= */
function calcLyeFromOils(rows,sf,type){
  const baseNa=sum(rows.map(([n,g])=>g*(SAP_NaOH[n]||0)));const neededNa=baseNa*(1-sf/100);
  const naPur=+($("#lyePurity").value||100), koPur=+($("#kohPurity").value||90);
  if(type==='NaOH')return{na:neededNa*(100/Math.max(1,naPur)),ko:0};
  if(type==='KOH'){const ko=neededNa*KOH_FACTOR*(100/Math.max(1,koPur));return{na:0,ko};}
  const pctNa=(+$("#dualPct").value||90)/100;
  const na=neededNa*pctNa*(100/Math.max(1,naPur));
  const ko=(neededNa*(1-pctNa)*KOH_FACTOR)*(100/Math.max(1,koPur));
  return{na,ko};
}
function waterFromMode(mode,param,totalNaOH_g,totalOils_g){
  if(mode==="ratio")return totalNaOH_g*param;
  if(mode==="pctOil")return totalOils_g*(param/100);
  if(mode==="pctSoln"||mode==="master"){const c=param/100;return totalNaOH_g*(1-c)/c;}
  return totalNaOH_g*2.5;
}
function addPct(gOils,p){return gOils*(p/100)}
function fragranceCap(t){return (FO_RULES[t]?.max ?? 4.5)}

/* ========= RESULTS ========= */
function concFrom(lye,water){const c=lye/(lye+water)*100;return isFinite(c)?c:0}
function calculate(){
  const rows=oilsAsGrams();const gOils=sum(rows.map(([_,g])=>g||0));
  const sf=+($("#superfat").value||0);const type=$("#lyeType").value;
  const {na,ko}=calcLyeFromOils(rows,sf,type);
  const totalNaEq=na+(ko/KOH_FACTOR);const water=waterFromMode($("#waterMode").value,+($("#waterParam").value||2.5),totalNaEq,gOils);
  const foType=$("#foType").value, foMax=fragranceCap(foType);const fragPct=+($("#fragPct").value||0);
  const slPct=+($("#slPct").value||0), saltPct=+($("#saltPct").value||0), sugarPct=+($("#sugarPct").value||0), clayPct=+($("#clayPct").value||0), chelPct=+($("#chelPct").value||0);
  const fo=addPct(gOils,fragPct), sl=addPct(gOils,slPct), salt=addPct(gOils,saltPct), sugar=addPct(gOils,sugarPct), clay=addPct(gOils,clayPct), chel=addPct(gOils,chelPct);
  const milk=water*((+$("#milkPct").value||0)/100);
  const batch=gOils+(na+ko)+water+fo+sl+salt+sugar+clay+chel;
  const pot=+($("#potMl").value||0), safeMin=pot*0.60, safeMax=pot*0.75;

  $("#resTable").innerHTML=`
    <tr><th>NaOH (solid)</th><td>${na.toFixed(2)} g (${oz(na).toFixed(2)} oz)</td></tr>
    <tr><th>KOH (flakes)</th><td>${ko.toFixed(2)} g (${oz(ko).toFixed(2)} oz)</td></tr>
    <tr><th>Water (total)</th><td>${water.toFixed(2)} g (${oz(water).toFixed(2)} oz)</td></tr>
    <tr><th>Milk portion</th><td>${milk.toFixed(2)} g (${(+$("#milkPct").value||0)}%)</td></tr>
    <tr><th>Fragrance / EO</th><td>${fo.toFixed(2)} g (${fragPct}%)</td></tr>
    <tr><th>Sodium Lactate</th><td>${sl.toFixed(2)} g (${slPct}%)</td></tr>
    <tr><th>Salt</th><td>${salt.toFixed(2)} g (${saltPct}%)</td></tr>
    <tr><th>Sugar</th><td>${sugar.toFixed(2)} g (${sugarPct}%)</td></tr>
    <tr><th>Clay</th><td>${clay.toFixed(2)} g (${clayPct}%)</td></tr>
    <tr><th>EDTA/Citrate</th><td>${chel.toFixed(2)} g (${chelPct}%)</td></tr>
    <tr><th><b>Total batch weight</b></th><td><b>${batch.toFixed(1)} g</b> (${oz(batch).toFixed(2)} oz)</td></tr>
    ${pot?`<tr><th>Recommended pot fill (60–75%)</th><td>${safeMin.toFixed(0)}–${safeMax.toFixed(0)} g</td></tr>`:''}
  `;
  const conc=concFrom(totalNaEq,water), caps=[];
  if(conc<25) caps.push(badge("warn",`Lye conc ${conc.toFixed(1)}% (dilute → slow trace)`));
  else if(conc<=33) caps.push(badge("ok",`Lye conc ${conc.toFixed(1)}% sweet spot`));
  else if(conc<=38) caps.push(badge("warn",`Lye conc ${conc.toFixed(1)}% (strong → fast trace)`));
  else caps.push(badge("danger",`Lye conc ${conc.toFixed(1)}% (very strong)`));
  const wm=$("#waterMode").value, wp=+($("#waterParam").value||2.5);
  if(wm==="ratio" && (wp<1.7||wp>3.0)) caps.push(badge("warn",`Water:lye ${wp} outside common 1.7–3.0`));
  const foCapBadge=(fragPct>foMax)?badge("danger",`FO/EO ${fragPct}% > max ${foMax}% (${ $("#foType").selectedOptions[0].text })`):(fragPct===0?badge("ok","FO/EO: 0 (unused)"):badge("ok",`FO/EO ${fragPct}% ≤ max ${foMax}%`));
  caps.push(foCapBadge);
  if((+$("#superfat").value||0)<2)caps.push(badge("warn","Superfat low (<2%)"));
  if((+$("#superfat").value||0)>12)caps.push(badge("danger","Superfat high (>12%)"));
  if(pot){if(batch>safeMax)caps.push(badge("danger","Exceeds ~75% pot capacity")); else if(batch>=safeMin)caps.push(badge("ok","Capacity: within headroom"))}
  $("#safetyBadges").innerHTML=caps.join(" ");
  $("#additiveBadges").innerHTML=
    rangeBadge(fragPct,0,foMax,"FO/EO")+
    rangeBadge(+$("#slPct").value||0,additivesSpec.sl.min,additivesSpec.sl.max,"Sodium Lactate")+
    rangeBadge(+$("#saltPct").value||0,additivesSpec.salt.min,additivesSpec.salt.max,"Salt")+
    rangeBadge(+$("#sugarPct").value||0,additivesSpec.sugar.min,additivesSpec.sugar.max,"Sugar")+
    rangeBadge(+$("#clayPct").value||0,additivesSpec.clay.min,additivesSpec.clay.max,"Clay")+
    rangeBadge(+$("#chelPct").value||0,additivesSpec.chel.min,additivesSpec.chel.max,"Chelator");
  $("#foNote").textContent=FO_RULES[$("#foType").value]?.tip||"";
  renderCostTable(rows,{fo}); window._last={na,ko,water,fo,batch,rows,gOils,conc,fragPct,foMax};
  // inventory check
  invCheckSufficiency();
}

/* ========= LYE-LIMITED ========= */
function profilePercentsLL(k){return profilePercents(k)}
function calcLyeLimited(){
  const naAvail=+$("#availLye").value||0, sf=+$("#sfLL").value||5, ratio=+$("#ratioLL").value||2.5;
  const plan=profilePercentsLL($("#profileLL").value);
  const SAPmix=sum(plan.map(([n,p])=>(p/100)*(SAP_NaOH[n]||0)));
  const oilsForNa=(naAvail)/((1-sf/100)*SAPmix);
  const fo=oilsForNa*0.03, water=naAvail*ratio;
  const rows=plan.map(([n,p])=>[n,oilsForNa*(p/100)]); const batch=oilsForNa+naAvail+water+fo;
  $("#llRes").innerHTML=`
    <tr><th>Total oils</th><td>${oilsForNa.toFixed(1)} g</td></tr>
    ${rows.map(([n,g])=>`<tr><th>&nbsp;&nbsp;• ${n}</th><td>${g.toFixed(1)} g</td></tr>`).join('')}
    <tr><th>NaOH</th><td>${naAvail.toFixed(1)} g</td></tr>
    <tr><th>Water (@ ${ratio})</th><td>${water.toFixed(1)} g</td></tr>
    <tr><th>FO (3%)</th><td>${fo.toFixed(1)} g</td></tr>
    <tr><th><b>Estimated batch</b></th><td><b>${batch.toFixed(1)} g</b></td></tr>
  `;
}

/* ========= DESIGN PLANNER ========= */
function designSplit(){
  const parts=+$("#designParts").value||2, type=$("#designType").value;
  const res=window._last; if(!res?.batch) return alert("Calculate first.");
  const table=$("#designTable"); table.innerHTML="";
  // default equal percentages for layers
  const rows=[...Array(parts)].map((_,i)=>({part:i+1,pct:(100/parts)}));
  let html=`<tr><th>#</th><th>% of batter</th><th>Grams batter</th><th>Notes</th></tr>`;
  rows.forEach(r=>{
    const grams = res.batch*(r.pct/100);
    html+=`<tr><td>${r.part}</td><td><input type="number" value="${r.pct.toFixed(2)}" class="dPct"></td><td>${grams.toFixed(1)} g</td><td>${type==="layers"?"Pour then rest "+($("#restMinutes").value||5)+" min":type==="itp"?"Color pots, pour at multiple compass points":"Pour medium trace, swirl with hanger 3–5 passes"}</td></tr>`;
  });
  table.innerHTML=html+`<tr><td colspan="4" class="note">Tip: Adjust % to match color plan. We recompute grams after edits.</td></tr>`;
  // wire recompute
  table.querySelectorAll('.dPct').forEach(inp=>{
    inp.addEventListener('input', debounce(()=>{
      const pctCells=[...table.querySelectorAll('.dPct')].map(x=>+x.value||0);
      const sumPct = pctCells.reduce((s,x)=>s+x,0)||1;
      [...table.rows].forEach((tr,i)=>{
        if(i===0||i===table.rows.length-1) return;
        const p = pctCells[i-1]; const g = res.batch*(p/ sumPct);
        tr.cells[2].textContent = `${g.toFixed(1)} g`;
      });
    },120));
  });
}

/* ========= MOLD LIBRARY ========= */
const KEY_MOLDS="BelLei_Molds";
function mAdd(){
  const name=$("#mName").value?.trim(); if(!name) return alert("Name your mold.");
  const type=$("#mType").value, L=+$("#mLibL").value||0, W=+$("#mLibW").value||0, H=+$("#mLibH").value||0, notes=$("#mNotes").value||"";
  const molds=JSON.parse(localStorage.getItem(KEY_MOLDS)||"{}"); molds[name]={type,L,W,H,notes};
  localStorage.setItem(KEY_MOLDS, JSON.stringify(molds)); mList();
}
function mList(){
  const molds=JSON.parse(localStorage.getItem(KEY_MOLDS)||"{}");
  const t=$("#mListTable"); let html=`<tr><th>Name</th><th>Spec</th><th>Notes</th><th></th></tr>`;
  const rows=Object.entries(molds);
  if(!rows.length){ t.innerHTML=`<tr><td class="note">No molds saved yet.</td></tr>`; return; }
  rows.forEach(([n,m])=>{
    let spec = m.type==="cavity" ? `Cavity ${m.L} mL × ${m.W}` : `${m.L}×${m.W}×${m.H} cm (${m.type})`;
    html+=`<tr><td>${n}</td><td>${spec}</td><td>${m.notes||''}</td><td>
      <button class="btn subtle" onclick="mUse('${n}')">Use</button>
      <button class="btn subtle" onclick="mDel('${n}')">Delete</button></td></tr>`;
  });
  t.innerHTML=html;
}
function mUse(name){
  const molds=JSON.parse(localStorage.getItem(KEY_MOLDS)||"{}"); const m=molds[name]; if(!m) return;
  let ml=0;
  if(m.type==="cavity") ml = (m.L||0)*(m.W||0);
  else ml = (m.L||0)*(m.W||0)*(m.H||0);
  if(ml>0){ const est=Math.round(ml*0.7); $("#targetOils").value=useOz?oz(est).toFixed(2):est; calculate(); alert(`Target oils estimated from ${name}: ~${est} g batter capacity ×0.7`); }
}
function mDel(name){
  const molds=JSON.parse(localStorage.getItem(KEY_MOLDS)||"{}"); delete molds[name]; localStorage.setItem(KEY_MOLDS, JSON.stringify(molds)); mList();
}

/* ========= INVENTORY ========= */
const KEY_INV="BelLei_Inventory";
function invTableRender(){
  const inv=JSON.parse(localStorage.getItem(KEY_INV)||"{}");
  const t=$("#invTable"); t.innerHTML=`<tr><th>Item</th><th>On hand (g)</th><th>Low stock alert (g)</th></tr>`;
  Object.entries(inv).forEach(([k,v])=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${k}</td><td><input type="number" value="${v.g||0}" data-k="${k}" class="invG"></td><td><input type="number" value="${v.low||0}" data-kl="${k}" class="invLow"></td>`;
    t.appendChild(tr);
  });
  // wire inputs
  t.querySelectorAll('.invG').forEach(i=>i.addEventListener('input',()=>{const inv=JSON.parse(localStorage.getItem(KEY_INV)||"{}"); inv[i.dataset.k]={...(inv[i.dataset.k]||{}), g:+i.value||0}; localStorage.setItem(KEY_INV, JSON.stringify(inv)); invCheckSufficiency();}));
  t.querySelectorAll('.invLow').forEach(i=>i.addEventListener('input',()=>{const inv=JSON.parse(localStorage.getItem(KEY_INV)||"{}"); inv[i.dataset.kl]={...(inv[i.dataset.kl]||{}), low:+i.value||0, g:(inv[i.dataset.kl]?.g||0)}; localStorage.setItem(KEY_INV, JSON.stringify(inv)); }));
}
function invAddItem(name, grams=0){
  const inv=JSON.parse(localStorage.getItem(KEY_INV)||"{}"); inv[name]={g: (inv[name]?.g||0), low: (inv[name]?.low||0)};
  localStorage.setItem(KEY_INV, JSON.stringify(inv));
}
function invLoadFromRecipe(){
  const res=window._last; if(!res) return alert("Calculate first.");
  res.rows.forEach(([n])=>invAddItem(n));
  ["Sodium Hydroxide","Water","Fragrance","Sodium Lactate","Salt","Sugar","Clay","EDTA/Citrate"].forEach(invAddItem);
  invTableRender();
}
function invSave(){ alert("Inventory saved locally."); }
function invCheckSufficiency(){
  const res=window._last; if(!res?.rows) return $("#invStatus").innerHTML="";
  const needs={};
  res.rows.forEach(([n,g])=>needs[n]=(needs[n]||0)+g);
  needs["Sodium Hydroxide"]=(res.na||0); needs["Water"]=(res.water||0); needs["Fragrance"]=(res.fo||0);
  const inv=JSON.parse(localStorage.getItem(KEY_INV)||"{}");
  const msgs=[];
  Object.entries(needs).forEach(([k,need])=>{
    const have=inv[k]?.g||0; const low=inv[k]?.low||0;
    if(have<need) msgs.push(badge("danger",`${k}: need ${need.toFixed(0)} g, have ${have.toFixed(0)} g`));
    else if(have-low<=need) msgs.push(badge("warn",`${k}: will drop below low stock (${low} g)`));
  });
  $("#invStatus").innerHTML = msgs.length? msgs.join(" ") : badge("ok","Inventory sufficient for this batch.");
}
function invAutoDeductIfEnabled(name){
  if(!$("#invAutoDeduct").checked) return;
  const res=window._last; if(!res?.rows) return;
  const inv=JSON.parse(localStorage.getItem(KEY_INV)||"{}");
  res.rows.forEach(([n,g])=>{ inv[n]={...(inv[n]||{}), g: Math.max(0,(inv[n]?.g||0)-g)}; });
  inv["Sodium Hydroxide"]={...(inv["Sodium Hydroxide"]||{}), g: Math.max(0,(inv["Sodium Hydroxide"]?.g||0) - (res.na||0))};
  inv["Water"]={...(inv["Water"]||{}), g: Math.max(0,(inv["Water"]?.g||0) - (res.water||0))};
  inv["Fragrance"]={...(inv["Fragrance"]||{}), g: Math.max(0,(inv["Fragrance"]?.g||0) - (res.fo||0))};
  localStorage.setItem(KEY_INV, JSON.stringify(inv));
  invTableRender(); invCheckSufficiency();
}

/* ========= LABELS / INCI ========= */
function oilsSortedByProminence(rows){ return [...rows].sort((a,b)=> b[1]-a[1]); }
function buildINCI(){
  const res=window._last; if(!res?.rows) return alert("Calculate first.");
  const sorted = oilsSortedByProminence(res.rows).map(([n])=>INCI[n]||n);
  const saponified = sorted.join(", ");
  const extra=[];
  if(res.fo>0) extra.push(INCI["Fragrance"]);
  extra.push(INCI["Water"]);
  extra.push(INCI["Sodium Hydroxide"]);
  const table=$("#inciTable");
  table.innerHTML=`
    <tr><th>Front label name</th><td><input id="labelName" placeholder="e.g., Charcoal Mint CP Soap"></td></tr>
    <tr><th>Ingredients (INCI)</th><td><div>Saponified oils of: <b>${saponified}</b>; ${extra.join(", ")}${res.fo>0?"; Fragrance/Essential Oil":""}${(+$("#clayPct").value||0)>0?"; Kaolin (Clay)":""}${(+$("#slPct").value||0)>0?"; Sodium Lactate":""}${(+$("#chelPct").value||0)>0?"; Sodium Citrate":""}${(+$("#saltPct").value||0)>0?"; Sodium Chloride":""}${(+$("#sugarPct").value||0)>0?"; Sucrose":""}.</div></td></tr>
    <tr><th>Net wt</th><td><input id="labelNet" placeholder="e.g., 4.5 oz (127 g)"></td></tr>
    <tr><th>Business info</th><td><textarea id="labelBiz" rows="3" placeholder="Bel Lei’s Soaps N Stuffs • City, ST • belleis.sns@gmail.com"></textarea></td></tr>
    <tr><th>Warnings</th><td><textarea id="labelWarn" rows="2">For external use only. Avoid eye contact. Discontinue if irritation occurs.</textarea></td></tr>
  `;
}
function labelPrint(){
  window.print();
}

/* ========= COSTING ========= */
const priceDB={};
function renderCostTable(rows, extras){
  const host=$("#costWrap"); host.innerHTML="";
  rows.forEach(([name,g])=>{
    const row=document.createElement("div"); row.className="row3";
    row.innerHTML=`
      <div><label>${name} — package cost ($)</label><input type="number" step="0.01" id="cost_${cssId(name)}" value="${priceDB[name]?.cost||0}"></div>
      <div><label>Package size (g)</label><input type="number" id="size_${cssId(name)}" value="${priceDB[name]?.size||0}"></div>
      <div class="note" style="align-self:end">Used: <b>${g.toFixed(1)} g</b></div>`;
    host.appendChild(row);
  });
  const fo=document.createElement("div"); fo.className="row3";
  fo.innerHTML=`
    <div><label>Fragrance/EO — package cost ($)</label><input type="number" step="0.01" id="cost_FO" value="${priceDB.FO?.cost||0}"></div>
    <div><label>Package size (g)</label><input type="number" id="size_FO" value="${priceDB.FO?.size||0}"></div>
    <div class="note" style="align-self:end">FO used: <b>${(extras?.fo||0).toFixed(1)} g</b></div>`;
  host.appendChild(fo);
}
function calcCost(){
  const rows=window._last?.rows||[]; let c=0;
  rows.forEach(([n,g])=>{const p={cost:+$(`#cost_${cssId(n)}`)?.value||0,size:+$(`#size_${cssId(n)}`)?.value||0};priceDB[n]=p;if(p.size>0)c+=(p.cost/p.size)*g;});
  const foCost={cost:+$("#cost_FO").value||0,size:+$("#size_FO").value||0};priceDB.FO=foCost;
  if(foCost.size>0)c+=(foCost.cost/foCost.size)*(window._last?.fo||0);
  const bars=+$("#barsCount").value||10, price=+$("#priceBar").value||0;
  const perBar=c/(bars||1), margin=price?((price-perBar)/price)*100:0;
  $("#costSummary").innerHTML=`
    <div>COGS (batch): <b>$${c.toFixed(2)}</b></div>
    <div>COGS per bar: <b>$${perBar.toFixed(2)}</b></div>
    <div>Price/bar: <b>$${price.toFixed(2)}</b></div>
    <div>Gross margin: <b>${margin.toFixed(1)}%</b></div>`;
}

/* ========= SAVE/LOAD / EXPORT ========= */
const KEY_REC="BelLei_Recipes";
function collectInputs(){
  return {
    oils:oilsAsGrams(), target:parseByUnit($("#targetOils").value||0), profile:$("#profile").value, percentMode,
    lyeType:$("#lyeType").value, lyePurity:+$("#lyePurity").value||100, kohPurity:+$("#kohPurity").value||90, dualPct:+$("#dualPct").value||90,
    sf:+$("#superfat").value||0, waterMode:$("#waterMode").value, waterParam:+$("#waterParam").value||2.5,
    milkPct:+$("#milkPct").value||0, potMl:+$("#potMl").value||0,
    adds:{fo:+$("#fragPct").value||0, sl:+$("#slPct").value||0, salt:+$("#saltPct").value||0, sugar:+$("#sugarPct").value||0, clay:+$("#clayPct").value||0, chel:+$("#chelPct").value||0},
    foType:$("#foType").value
  };
}
function applyInputs(d){
  $("#targetOils").value=useOz?oz(d.target||1000).toFixed(2):(d.target||1000);
  $("#profile").value=d.profile||"PF45-30-15-10"; percentMode=!!d.percentMode; $("#pctBtn").textContent=`Percent mode: ${percentMode?'On':'Off'}`;
  $("#lyeType").value=d.lyeType||"NaOH"; $("#lyePurity").value=d.lyePurity||100; $("#kohPurity").value=d.kohPurity||90; $("#dualPct").value=d.dualPct||90;
  $("#superfat").value=d.sf||5; $("#waterMode").value=d.waterMode||"ratio"; $("#waterParam").value=d.waterParam||2.5;
  $("#milkPct").value=d.milkPct||0; $("#potMl").value=d.potMl||0; $("#foType").value=d.foType||"FO";
  $("#fragPct").value=d.adds?.fo??3; $("#slPct").value=d.adds?.sl??0; $("#saltPct").value=d.adds?.salt??0; $("#sugarPct").value=d.adds?.sugar??0; $("#clayPct").value=d.adds?.clay??0; $("#chelPct").value=d.adds?.chel??0;
  $("#oilBody").innerHTML="";
  if(percentMode){const tot=sum((d.oils||defaults.oils).map(r=>r[1]||0))||1;(d.oils||defaults.oils).forEach(([n,g])=>addOilRow(n,(g/tot*100).toFixed(2)));$("#wtHdr").textContent="Percent (%)";}
  else{(d.oils||defaults.oils).forEach(([n,g])=>addOilRow(n,g));$("#wtHdr").textContent=`Weight (${useOz?'oz':'g'})`;}
}
function saveRecipe(){
  const name=prompt("Recipe name to save:", $("#recName").value||"").trim(); if(!name) return;
  const all=JSON.parse(localStorage.getItem(KEY_REC)||"{}"); all[name]=collectInputs();
  localStorage.setItem(KEY_REC, JSON.stringify(all)); $("#recName").value=name; alert("Saved!");
  if($("#invAutoDeduct").checked) invAutoDeductIfEnabled(name);
}
function loadRecipe(){
  const name=prompt("Load which recipe name?", $("#recName").value||"").trim(); if(!name) return;
  const all=JSON.parse(localStorage.getItem(KEY_REC)||"{}"); const d=all[name]; if(!d) return alert("Not found.");
  applyInputs(d); calculate();
}
function listRecipes(){
  const all=JSON.parse(localStorage.getItem(KEY_REC)||"{}"); const list=Object.keys(all);
  $("#saveList").innerHTML=list.length?list.map(n=>`<div class="tag">${n}</div>`).join(''):`<div class="note">No saved recipes yet.</div>`;
}
function deleteRecipe(){
  const name=prompt("Delete which recipe name?", $("#recName").value||"").trim(); if(!name) return;
  const all=JSON.parse(localStorage.getItem(KEY_REC)||"{}"); delete all[name]; localStorage.setItem(KEY_REC, JSON.stringify(all)); listRecipes(); alert("Deleted (if it existed).");
}
function exportJSON(){
  const payload={ts:new Date().toISOString(), inputs:collectInputs(), results:window._last||{}};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="BelLeis_Recipe.json"; a.click();
}

/* ========= LABEL / GUIDE HELPERS ========= */
function rangeBadge(val,min,max,label){
  if(val===0) return badge("ok",`${label}: 0 (unused)`);
  if(val<min) return badge("warn",`${label}: low (${val.toFixed(2)}%; min ${min}%)`);
  if(val>max) return badge("danger",`${label}: high (${val.toFixed(2)}%; max ${max}%)`);
  return badge("ok",`${label}: ${val.toFixed(2)}% ok`);
}
function guideBuild(){
  const r=window._last; if(!r?.rows) return alert("Calculate first.");
  const steps=[];
  steps.push(`1) Prep: Wear gloves/goggles. Ventilate. Measure additives. Chill milk portion if using.`);
  steps.push(`2) Lye solution: Slowly add lye to water (never water to lye). Keep under 100°F (38°C), cooler for milk.`);
  steps.push(`3) Melt/temper oils: Warm hard oils just to melt, combine with liquids. Aim oils and lye within ~85–100°F.`);
  steps.push(`4) Emulsify: Stick blend to thin/medium trace depending on design.`);
  steps.push(`5) Additives: ${(+$("#slPct").value||0)>0?'Sodium lactate to cool lye water; ':''}${(+$("#clayPct").value||0)>0?'disperse clays; ':''}add fragrance at light trace if it accelerates.`);
  steps.push(`6) Pour: Follow Design Planner amounts. Rest ${+$("#restMinutes").value||5} min between layers if using layers.`);
