<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lye, Dye, and DIY ‚Äî Soap Batch Calculator</title>
<style>
  :root{
    --wine:#98273B;      /* brand */
    --rose:#F7707E;      /* accent */
    --olive:#7F894B;     /* accent */
    --ink:#2c2c2c;
    --muted:#6d6d6d;
    --bg:#fff7f8;
    --card:#ffffff;
    --line:#e9dde0;
    --good:#1d8f3e;
    --warn:#c98a00;
    --bad:#c62828;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  header{background:var(--wine);color:#fff;padding:14px 16px;box-shadow:0 2px 0 rgba(0,0,0,.08)}
  header h1{margin:0;font-size:22px;letter-spacing:.5px}
  header small{display:block;opacity:.9}
  .container{max-width:980px;margin:0 auto;padding:16px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px}
  .tab{border:1px solid var(--wine);background:#fff;color:var(--wine);padding:10px 12px;border-radius:999px;cursor:pointer}
  .tab.active{background:var(--wine);color:#fff}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px}
  .btn,.subtle{border:1px solid var(--wine);background:var(--wine);color:#fff;border-radius:12px;padding:12px 14px;cursor:pointer}
  .subtle{background:#fff;color:var(--wine)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:10px 0}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-weight:600;font-size:14px;color:var(--olive)}
  input,select,textarea{width:100%;padding:12px;border:1px solid #cfc6c7;border-radius:10px;font-size:16px;background:#fff}
  .mini{font-size:12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
  th{background:#faf5f6;color:#5a1e29}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
  .good{background:#e6f6ea;color:var(--good)}
  .warn{background:#fff6e0;color:var(--warn)}
  .bad{background:#fde7e7;color:var(--bad)}
  .meter{display:flex;gap:6px;align-items:center}
  .kpi{font-weight:800}
  footer{color:#7a7a7a;font-size:12px;text-align:center;margin:18px 0}
  .pill{display:inline-block;background:#fff;border:1px dashed var(--olive);color:var(--olive);padding:6px 10px;border-radius:999px;font-size:12px}
  .right{margin-left:auto}

  /* collapsible sections in Pro */
  .collapser{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:8px 0}
  .chev{font-weight:900;color:var(--wine)}
  .collapsed .collapsible-body{display:none}

  @media (max-width:600px){
    body{font-size:18px;line-height:1.44}
    .container{padding:12px}
    .grid{grid-template-columns:1fr}
    .btn,.subtle{padding:14px 16px}
    input,select,textarea{padding:14px;font-size:18px}
    .tab{padding:10px 12px}
    th,td{padding:10px}
  }
</style>
</head>
<body>
<header>
  <h1>Lye, Dye, and DIY</h1>
  <small>Bel Lei‚Äôs Soaps N Stuffs ‚Ä¢ Beginner-friendly, pro-accurate calculator</small>
</header>

<div class="container">
  <nav class="tabs" id="tabs">
    <button class="tab active" data-tab="calc">Calculator</button>
    <button class="tab" data-tab="lyelimited">Lye-Limited</button>
    <button class="tab" data-tab="cost">Cost & Profit</button>
    <span class="right pill">Install: use browser ‚ÄúAdd to Home Screen‚Äù</span>
  </nav>

  <div class="toolbar">
    <button class="subtle" id="printBtn">üñ®Ô∏è Print</button>
    <button class="subtle" id="exportBtn">üíæ Export JSON</button>
    <button class="subtle" id="saveBtn">Save</button>
    <button class="subtle" id="loadBtn">Load</button>
  </div>

  <!-- ===================== CALCULATOR ===================== -->
  <section id="tab-calc">
    <div class="card">
      <div class="row" style="margin-bottom:8px">
        <button class="btn" id="quickModeBtn" type="button">Quick Mode</button>
        <button class="subtle" id="proModeBtn" type="button">Pro Mode</button>
      </div>

      <!-- QUICK MODE -->
      <div class="card" id="quickModeCard" style="border:2px solid var(--olive);background:#fbfff5">
        <div class="grid">
          <label>Desired total oils (g)
            <input type="number" id="qm_oils" value="1000" min="100">
          </label>
          <label>Recipe profile
            <select id="qm_profile">
              <option value="palmFreeBalanced">Palm-Free Balanced (45/30/15/10)</option>
              <option value="lardBalanced">Lard Balanced (Olive/Lard/Coconut/Shea/Castor)</option>
            </select>
          </label>
          <label>Superfat / Lye Discount (%)
            <input type="number" id="qm_sf" value="5" min="0" max="15" step="0.5">
          </label>
          <label>Water mode
            <select id="qm_waterMode">
              <option value="ratio">Water : Lye ratio</option>
              <option value="conc">Lye solution concentration %</option>
            </select>
          </label>
          <label id="qm_ratio_wrap">Water : Lye
            <input type="number" id="qm_ratio" value="2.5" step="0.1">
          </label>
          <label id="qm_conc_wrap" style="display:none">Lye concentration (%)
            <input type="number" id="qm_conc" value="30" min="20" max="50" step="0.5">
          </label>
          <label>Fragrance / EO %
            <input type="number" id="qm_fo" value="3" step="0.1" min="0">
          </label>
          <label>Pot / Crockpot capacity (mL) <span class="mini">(for overflow check)</span>
            <input type="number" id="qm_pot" value="5678" min="1000">
          </label>
          <div class="row">
            <button class="btn" id="qm_build" type="button">Build this recipe</button>
            <span class="mini">Quick Mode fills the Oils table from your chosen profile, then you can switch to Pro to tweak.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- PRO MODE -->
    <div class="card pro-mode-block" id="profileCard">
      <div class="grid">
        <label>Desired total oils (g)
          <input type="number" id="targetOils" value="1000" min="100">
        </label>
        <label>Recipe profile
          <select id="profileSelect">
            <option value="palmFreeBalanced">Palm-Free Balanced (45/30/15/10)</option>
            <option value="lardBalanced">Lard Balanced (Olive/Lard/Coconut/Shea/Castor)</option>
          </select>
        </label>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="subtle" id="applyProfileBtn" type="button">Apply profile to oils</button>
        <span class="mini">Tip: set a target (e.g., 750 g, 1400 g) then Apply profile to auto-fill each oil.</span>
      </div>
    </div>

    <div class="card pro-mode-block" id="oilsCard">
      <div class="collapser" onclick="toggleFold('oilsCard')">
        <span>Oils ‚Äî add weights in grams (percentages shown in results)</span><span class="chev" id="chev-oilsCard">‚ñæ</span>
      </div>
      <div class="collapsible-body">
        <table>
          <thead><tr><th style="width:48%">Oil</th><th style="width:28%">Weight (g)</th><th>Remove</th></tr></thead>
          <tbody id="oilTbody"></tbody>
        </table>
        <div class="row" style="margin-top:8px">
          <button class="subtle" id="addOilBtn" type="button">+ Add oil</button>
        </div>
        <div class="mini">Available oils include Olive (pure), Coconut 76¬∞, Avocado, Lard, Shea butter, Castor. SAP values are built-in.</div>
      </div>
    </div>

    <div class="card pro-mode-block" id="lyeCard">
      <div class="collapser" onclick="toggleFold('lyeCard')">
        <span>Lye, water & extras</span><span class="chev" id="chev-lyeCard">‚ñæ</span>
      </div>
      <div class="collapsible-body grid">
        <label>Lye type
          <select id="lyeType">
            <option value="NaOH">NaOH (bar)</option>
          </select>
        </label>
        <label>Lye purity (%)
          <input type="number" id="lyePurity" value="100" min="90" max="100">
        </label>
        <label>Superfat / Lye Discount (%)
          <input type="number" id="superfat" value="5" min="0" max="15" step="0.5">
        </label>
        <label>Water mode
          <select id="waterMode">
            <option value="ratio">Water : Lye ratio</option>
            <option value="conc">Lye solution concentration %</option>
          </select>
        </label>
        <label id="waterRatioWrap">Water : Lye
          <input type="number" id="waterRatio" value="2.5" step="0.1">
        </label>
        <label id="waterConcWrap" style="display:none">Lye concentration (%)
          <input type="number" id="lyeConc" value="30" min="20" max="50" step="0.5">
        </label>
        <label>Milk replacement (% of liquid)
          <input type="number" id="milkPct" value="0" min="0" max="100">
        </label>
        <label>Fragrance / EO %
          <input type="number" id="foPct" value="3" step="0.1" min="0">
        </label>
        <label>Pot / Crockpot capacity (mL)
          <input type="number" id="potMl" value="5678" min="1000">
        </label>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button class="btn" id="calcBtn" type="button">Calculate</button>
      </div>
    </div>

    <div class="card" id="resultsCard">
      <h3 style="margin:0 0 8px">Batch Results</h3>
      <div class="grid">
        <div>
          <div>NaOH (Lye) Needed: <span class="kpi" id="lyeNeed">‚Äì</span></div>
          <div>Water Needed: <span class="kpi" id="waterNeed">‚Äì</span></div>
          <div>Milk portion (of water): <span class="kpi" id="milkNeed">‚Äì</span> <span class="mini">(if milk % &gt; 0)</span></div>
          <div>Fragrance Amount: <span class="kpi" id="foNeed">‚Äì</span></div>
          <div>Total Batch Weight: <span class="kpi" id="batchTot">‚Äì</span></div>
        </div>
        <div>
          <div class="meter">Lye concentration:
            <span id="concBadge" class="badge">‚Äì</span>
          </div>
          <div class="meter">Water : Lye:
            <span id="ratioBadge" class="badge">‚Äì</span>
          </div>
          <div class="meter">Fragrance %:
            <span id="foBadge" class="badge">‚Äì</span>
          </div>
          <div class="meter">Capacity status:
            <span id="capBadge" class="badge">‚Äì</span>
          </div>
        </div>
      </div>
      <div style="margin-top:10px">
        <details>
          <summary><b>Oil breakdown</b> (g & % of oils)</summary>
          <div id="oilBreak"></div>
        </details>
      </div>
    </div>
  </section>

  <!-- ===================== LYE-LIMITED (demo) ===================== -->
  <section id="tab-lyelimited" style="display:none">
    <div class="card">
      <h3 style="margin:0 0 8px">Lye-Limited Mode</h3>
      <div class="grid">
        <label>How much lye do you have? (g)
          <input type="number" id="lim_lye" value="100" min="10">
        </label>
        <label>Water : Lye
          <input type="number" id="lim_ratio" value="2.5" step="0.1">
        </label>
        <label>Superfat / Lye Discount (%)
          <input type="number" id="lim_sf" value="5" min="0" max="15">
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="lim_calc">Calculate oils from lye</button>
      </div>
      <div id="lim_res" class="mini"></div>
    </div>
  </section>

  <!-- ===================== COST (simple demo) ===================== -->
  <section id="tab-cost" style="display:none">
    <div class="card">
      <h3 style="margin:0 0 8px">Cost & Profit (simple)</h3>
      <div class="grid">
        <label>Fragrance cost ($ / g)
          <input type="number" id="costFO" value="0.02" step="0.001">
        </label>
        <label>Bar size (g)
          <input type="number" id="barG" value="113">
        </label>
        <label>Margin target (%)
          <input type="number" id="marginPct" value="60">
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="calcCost">Estimate cost & price</button>
      </div>
      <div class="mini" id="costResults"></div>
      <div class="mini" id="priceSuggest"></div>
    </div>
  </section>

  <footer>
    ¬© 2025 Bel Lei‚Äôs Soaps N Stuffs ‚Ä¢ Lye, Dye, and DIY
  </footer>
</div>

<script>
/* ---------- Data ---------- */
const SAP = { // NaOH SAP (g NaOH / g oil)
  "Olive Oil (pure)": 0.134,
  "Coconut Oil (76¬∞)": 0.183,
  "Avocado Oil": 0.133,
  "Lard": 0.138,
  "Shea Butter": 0.128,
  "Castor Oil": 0.128
};
const OIL_OPTIONS = Object.keys(SAP);

const PROFILES = {
  palmFreeBalanced: [
    {oil:"Olive Oil (pure)", pct:45},
    {oil:"Coconut Oil (76¬∞)", pct:30},
    {oil:"Shea Butter", pct:15},
    {oil:"Castor Oil", pct:10},
  ],
  lardBalanced: [
    {oil:"Olive Oil (pure)", pct:40},
    {oil:"Lard", pct:30},
    {oil:"Coconut Oil (76¬∞)", pct:20},
    {oil:"Shea Butter", pct:5},
    {oil:"Castor Oil", pct:5},
  ],
};

/* ---------- Helpers ---------- */
function el(tag, attrs={}, html=""){
  const e=document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=> e.setAttribute(k,v));
  if(html!==undefined && html!=="") e.innerHTML = html;
  return e;
}
function fmtG(n){ return `${(n).toFixed(2)} g`; }
function badge(elm, level, text){
  elm.className="badge "+(level==="good"?"good":level==="warn"?"warn":"bad");
  elm.textContent=text;
}

/* ---------- Tabs ---------- */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const id=t.dataset.tab;
    ["calc","lyelimited","cost"].forEach(name=>{
      document.getElementById('tab-'+name).style.display = (name===id)?'':'none';
    });
  });
});

/* ---------- Oils table ---------- */
const oilTbody = document.getElementById('oilTbody');
function addOilRowWith(oil, grams){
  const tr=el('tr');
  const oilSel=el('select',{'class':'oilName'});
  OIL_OPTIONS.forEach(name=>{
    const opt=el('option',{},name);
    if(name===oil) opt.selected=true;
    oilSel.appendChild(opt);
  });
  const gIn=el('input',{'type':'number','class':'oilGrams','min':'0','step':'0.1','value': grams?grams:0});
  const rm=el('button',{'type':'button','class':'subtle'},'Remove');
  rm.addEventListener('click',()=> tr.remove());
  tr.appendChild(el('td',{},'')); tr.children[0].appendChild(oilSel);
  tr.appendChild(el('td',{},'')); tr.children[1].appendChild(gIn);
  tr.appendChild(el('td',{},'')); tr.children[2].appendChild(rm);
  oilTbody.appendChild(tr);
}
function clearOilRows(){ oilTbody.innerHTML=""; }
document.getElementById('addOilBtn').addEventListener('click', ()=> addOilRowWith(OIL_OPTIONS[0],0));

/* Seed with a couple rows */
addOilRowWith("Olive Oil (pure)", 450);
addOilRowWith("Coconut Oil (76¬∞)", 300);
addOilRowWith("Shea Butter", 150);
addOilRowWith("Castor Oil", 100);

/* ---------- Profiles ---------- */
document.getElementById('applyProfileBtn').addEventListener('click', ()=>{
  const key=document.getElementById('profileSelect').value;
  const target=parseFloat(document.getElementById('targetOils').value)||1000;
  const prof=PROFILES[key];
  if(!prof) return;
  clearOilRows();
  prof.forEach(p=> addOilRowWith(p.oil, target*(p.pct/100)));
});

/* ---------- Quick / Pro toggle ---------- */
const quickBtn = document.getElementById('quickModeBtn');
const proBtn   = document.getElementById('proModeBtn');
const quickBox = document.getElementById('quickModeCard');
const proBlocks = Array.from(document.querySelectorAll('.pro-mode-block'));
function setMode(mode){
  const quick=(mode==='quick');
  if(quickBox) quickBox.style.display = quick?'':'none';
  proBlocks.forEach(el=> el.style.display = quick?'none':'');
  quickBtn.classList.toggle('subtle', !quick);
  proBtn.classList.toggle('subtle', quick);
  localStorage.setItem('ldd_mode', mode);
}
setMode(localStorage.getItem('ldd_mode') || 'quick');
quickBtn.addEventListener('click',()=> setMode('quick'));
proBtn.addEventListener('click',()=> setMode('pro'));

document.getElementById('qm_waterMode').addEventListener('change',(e)=>{
  const v=e.target.value;
  document.getElementById('qm_ratio_wrap').style.display=(v==='ratio')?'':'none';
  document.getElementById('qm_conc_wrap').style.display=(v==='conc')?'':'none';
});

document.getElementById('qm_build').addEventListener('click', ()=>{
  const oils = parseFloat(document.getElementById('qm_oils').value)||1000;
  const key  = document.getElementById('qm_profile').value;
  const prof = PROFILES[key];
  clearOilRows();
  prof.forEach(p=> addOilRowWith(p.oil, oils*(p.pct/100)));
  // map settings
  document.getElementById('targetOils').value  = oils;
  document.getElementById('profileSelect').value = key;
  document.getElementById('superfat').value    = document.getElementById('qm_sf').value;
  document.getElementById('foPct').value       = document.getElementById('qm_fo').value;
  document.getElementById('potMl').value       = document.getElementById('qm_pot').value;
  const wm=document.getElementById('qm_waterMode').value;
  document.getElementById('waterMode').value=wm;
  if(wm==='ratio'){ document.getElementById('waterRatio').value=document.getElementById('qm_ratio').value;
                    document.getElementById('waterRatioWrap').style.display='';
                    document.getElementById('waterConcWrap').style.display='none';
  } else { document.getElementById('lyeConc').value=document.getElementById('qm_conc').value;
           document.getElementById('waterConcWrap').style.display='';
           document.getElementById('waterRatioWrap').style.display='none';
  }
  setMode('pro'); // jump to Pro to review
  document.getElementById('calcBtn').click();
});

/* ---------- Water mode switch in Pro ---------- */
document.getElementById('waterMode').addEventListener('change',(e)=>{
  const v=e.target.value;
  document.getElementById('waterRatioWrap').style.display=(v==='ratio')?'':'none';
  document.getElementById('waterConcWrap').style.display=(v==='conc')?'':'none';
});

/* ---------- Collapsible ---------- */
function toggleFold(id){
  const box=document.getElementById(id);
  if(!box) return;
  box.classList.toggle('collapsed');
  const chev=document.getElementById('chev-'+id);
  if(chev) chev.textContent = box.classList.contains('collapsed')?'‚ñ∏':'‚ñæ';
}

/* ---------- Core Calculation ---------- */
function gatherOils(){
  const rows=[...document.querySelectorAll('#oilTbody tr')];
  return rows.map(r=>{
    const name=r.querySelector('.oilName').value;
    const g=parseFloat(r.querySelector('.oilGrams').value)||0;
    return {name,g,sap:SAP[name]??0.135};
  });
}
function sum(arr, fn){ return arr.reduce((a,x)=>a+(fn?fn(x):x),0); }

function calc(){
  const oils = gatherOils();
  const totalOils = sum(oils, o=>o.g);
  const sapNaoh = sum(oils, o=> o.sap * o.g); // g NaOH for 0% SF
  const sf = (parseFloat(document.getElementById('superfat').value)||0)/100;
  const lyePur = (parseFloat(document.getElementById('lyePurity').value)||100)/100;
  let naoh = sapNaoh * (1 - sf) / lyePur;

  // Water by ratio or concentration
  const wm = document.getElementById('waterMode').value;
  let water=0, conc=0, ratio=0;
  if(wm==='ratio'){
    ratio=parseFloat(document.getElementById('waterRatio').value)||2.5;
    water = naoh * ratio;
    conc = naoh / (naoh + water) * 100;
  }else{
    conc = parseFloat(document.getElementById('lyeConc').value)||30;
    // conc% = lye / (lye+water) -> water = lye*(100/conc - 1)
    water = naoh * (100/conc - 1);
    ratio = water / naoh;
  }

  const milkPct = (parseFloat(document.getElementById('milkPct').value)||0)/100;
  const milkG = water * milkPct;
  const foPct  = (parseFloat(document.getElementById('foPct').value)||0)/100;
  const foG    = totalOils * foPct;

  const batchG = totalOils + naoh + water + foG;
  const potMl  = parseFloat(document.getElementById('potMl').value)||0;
  const safeMin = potMl*0.60;
  const safeMax = potMl*0.75;

  // UI fill
  document.getElementById('lyeNeed').textContent   = fmtG(naoh);
  document.getElementById('waterNeed').textContent = fmtG(water);
  document.getElementById('milkNeed').textContent  = milkPct>0?fmtG(milkG):'‚Äî';
  document.getElementById('foNeed').textContent    = fmtG(foG);
  document.getElementById('batchTot').textContent  = fmtG(batchG);

  // oil breakdown
  const ob = oils.map(o=>{
    const pct = totalOils? (o.g/totalOils*100):0;
    return `<div>${o.name}: <b>${fmtG(o.g)}</b> (${pct.toFixed(1)}%)</div>`;
  }).join("");
  document.getElementById('oilBreak').innerHTML = ob || '<div class="mini">No oils entered.</div>';

  // Safety badges
  const concB = document.getElementById('concBadge');
  if(conc<25) badge(concB,'bad', `${conc.toFixed(1)}% ‚Ä¢ too dilute (slow)`);
  else if(conc<28) badge(concB,'warn', `${conc.toFixed(1)}% ‚Ä¢ on dilute side`);
  else if(conc<=33) badge(concB,'good', `${conc.toFixed(1)}% ‚Ä¢ sweet spot`);
  else if(conc<=38) badge(concB,'warn', `${conc.toFixed(1)}% ‚Ä¢ strong, monitor`);
  else badge(concB,'bad', `${conc.toFixed(1)}% ‚Ä¢ very strong`);

  const ratioB = document.getElementById('ratioBadge');
  ratioB.className='badge good';
  ratioB.textContent = `${ratio.toFixed(2)} : 1`;

  const fop = foPct*100;
  const foB = document.getElementById('foBadge');
  if(fop>6) badge(foB,'bad', `${fop.toFixed(1)}% ‚Ä¢ high`);
  else if(fop>=2 && fop<=4.5) badge(foB,'good', `${fop.toFixed(1)}% ‚Ä¢ typical`);
  else badge(foB,'warn', `${fop.toFixed(1)}% ‚Ä¢ check IFRA`);

  const capB = document.getElementById('capBadge');
  if(!potMl){ badge(capB,'warn',"no pot size"); }
  else if(batchG>safeMax) badge(capB,'bad', `Over (>${safeMax.toFixed(0)} g)` );
  else if(batchG<safeMin) badge(capB,'warn', `Low (<${safeMin.toFixed(0)} g)`);
  else badge(capB,'good', 'Safe');

  // expose some values for cost tab
  window.__calcState = { totalOils, naoh, water, foG, batchG };
}

/* Hook calculate */
document.getElementById('calcBtn').addEventListener('click', calc);

/* ---------- Lye-limited demo ---------- */
document.getElementById('lim_calc').addEventListener('click', ()=>{
  const lye = parseFloat(document.getElementById('lim_lye').value)||0;
  const ratio = parseFloat(document.getElementById('lim_ratio').value)||2.5;
  const sf = (parseFloat(document.getElementById('lim_sf').value)||5)/100;
  // approximate average NaOH SAP ~0.136 g/g ‚Üí oils ‚âà lye / (SAP*(1-sf))
  const oils = lye / (0.136*(1-sf));
  const water = lye*ratio;
  document.getElementById('lim_res').textContent =
    `Approx oils you can saponify: ${oils.toFixed(1)} g | Water: ${water.toFixed(1)} g (ratio ${ratio}:1, SF ${sf*100}%)`;
});

/* ---------- Cost (simple) ---------- */
document.getElementById('calcCost').addEventListener('click', ()=>{
  const s=window.__calcState||{};
  const foCostPerG = parseFloat(document.getElementById('costFO').value)||0;
  const foCost = (s.foG||0)*foCostPerG;
  const baseCost = foCost; // extend later with per-oil costs
  const bars = Math.max(1, Math.floor((s.batchG||1000) / ((parseFloat(document.getElementById('barG').value)||113))));
  const costPerBar = baseCost / bars;
  const margin = (parseFloat(document.getElementById('marginPct').value)||60)/100;
  const suggested = costPerBar / (1 - margin);
  document.getElementById('costResults').textContent = `FO cost ‚âà $${baseCost.toFixed(2)} (will expand to full ingredient costing).`;
  document.getElementById('priceSuggest').textContent = `~${bars} bars ‚Üí cost/bar ‚âà $${costPerBar.toFixed(2)} ‚áí suggested price ‚âà $${suggested.toFixed(2)}.`;
});

/* ---------- Save/Load/Print/Export ---------- */
document.getElementById('printBtn').addEventListener('click', ()=> window.print());
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const data = {
    oils: gatherOils(),
    settings: {
      sf: document.getElementById('superfat').value,
      wm: document.getElementById('waterMode').value,
      ratio: document.getElementById('waterRatio').value,
      conc: document.getElementById('lyeConc').value,
      milk: document.getElementById('milkPct').value,
      fo: document.getElementById('foPct').value,
      pot: document.getElementById('potMl').value
    }
  };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='recipe.json';
  a.click();
});
document.getElementById('saveBtn').addEventListener('click', ()=>{
  const payload = {
    oils: gatherOils(),
    sf: document.getElementById('superfat').value,
    wm: document.getElementById('waterMode').value,
    ratio: document.getElementById('waterRatio').value,
    conc: document.getElementById('lyeConc').value,
    milk: document.getElementById('milkPct').value,
    fo: document.getElementById('foPct').value,
    pot: document.getElementById('potMl').value
  };
  localStorage.setItem('ldd_recipe', JSON.stringify(payload));
  alert('Saved locally on this device.');
});
document.getElementById('loadBtn').addEventListener('click', ()=>{
  const txt = localStorage.getItem('ldd_recipe'); if(!txt){ alert('Nothing saved yet.'); return; }
  const r = JSON.parse(txt);
  clearOilRows(); r.oils.forEach(o=> addOilRowWith(o.name, o.g));
  document.getElementById('superfat').value=r.sf;
  document.getElementById('waterMode').value=r.wm;
  document.getElementById('waterRatio').value=r.ratio;
  document.getElementById('lyeConc').value=r.conc;
  document.getElementById('milkPct').value=r.milk;
  document.getElementById('foPct').value=r.fo;
  document.getElementById('potMl').value=r.pot;
  document.getElementById('waterRatioWrap').style.display=(r.wm==='ratio')?'':'none';
  document.getElementById('waterConcWrap').style.display=(r.wm==='conc')?'':'none';
  alert('Loaded. Press Calculate to refresh results.');
});
</script>
</body>
</html>
