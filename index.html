<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lye, Dye, and DIY — Bel Lei’s Soap Calculator (v0.6)</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" sizes="192x192" href="icons/icon-192.png">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="theme-color" content="#98273B">
<style>
:root{
  --brand:#98273B; --brand2:#F7707E; --olive:#7F894B;
  --ink:#222; --muted:#6b7280; --bg:#fff8f8; --panel:#ffffff;
  --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --line:#eef2f7;
  --ring:0 0 0 3px rgba(152,39,59,.18);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
header{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:18px 14px}
h1{margin:0 0 4px;font-size:26px;letter-spacing:.3px}
.small{opacity:.9;font-size:13px}
.container{max-width:1000px;margin:14px auto;padding:0 12px}
.card{background:var(--panel);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:14px}
.grid{display:grid;gap:12px}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 12px}
.btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700}
.btn.subtle{background:#fff;border:1px solid #e5e7eb;color:var(--ink)}
.btn.alt{background:var(--olive);color:#fff}
.btn:focus{outline:none;box-shadow:var(--ring)}
.tabbar{display:flex;gap:8px;flex-wrap:wrap}
.tab{background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:8px 12px;cursor:pointer}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
input,select,textarea{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
label{font-weight:700;font-size:14px;margin-bottom:6px;display:block}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.badge{display:inline-flex;align-items:center;gap:6px;font-weight:700;padding:6px 10px;border-radius:999px;font-size:12px}
.b-ok{background:#ecfdf5;color:#065f46}
.b-warn{background:#fffbeb;color:#92400e}
.b-danger{background:#fef2f2;color:#991b1b}
.note{font-size:13px;color:var(--muted)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
.kpi{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
.kpi > div{background:#f9fafb;border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-size:13px}
.section-title{display:flex;align-items:center;justify-content:space-between;margin:6px 0 8px}
.tag{background:#fff;border:1px solid #e5e7eb;padding:5px 8px;border-radius:8px;font-size:12px}
fieldset{border:none;margin:0;padding:0}
legend{font-weight:800;margin-bottom:6px}
.hide{display:none!important}
.stickyCalc{position:sticky;bottom:10px;z-index:5}
blockquote.tip{border-left:4px solid var(--olive);padding:6px 10px;background:#fbfff5;border-radius:6px}
@media (max-width:760px){
  .row,.row3{grid-template-columns:1fr}
  header{padding:16px 12px}
  h1{font-size:22px}
}
@media print{
  header,.tabbar,.controls .btn,#installBtn{display:none!important}
  body{background:#fff}
  .card{box-shadow:none;border:1px solid #ddd}
}
</style>
</head>
<body>
<header>
  <h1>Lye, Dye, and DIY</h1>
  <div class="small">Bel Lei’s Soaps N Stuffs • Beginner-friendly, pro-accurate calculator (v0.6)</div>
</header>

<div class="container grid">

  <!-- tabs -->
  <div class="tabbar" role="tablist" aria-label="sections">
    <div class="tab active" data-tab="calc">Calculator</div>
    <div class="tab" data-tab="design">Design Helper</div>
    <div class="tab" data-tab="lyelimited">Lye-Limited</div>
    <div class="tab" data-tab="cost">Cost & Profit</div>
    <div class="tab" data-tab="save">Save / Load</div>
    <div class="tab" data-tab="install"><span id="installLabel">Install App</span></div>
  </div>

  <!-- CALC -->
  <section class="card grid" id="calc" role="tabpanel">
    <div class="section-title">
      <h2 style="margin:0">Calculator</h2>
      <span class="tag" id="modeTag">Quick Mode</span>
    </div>

    <div class="controls">
      <button class="btn subtle" onclick="quickMode()">Quick</button>
      <button class="btn subtle" onclick="togglePro()">Pro Mode</button>
      <button class="btn subtle" onclick="copyRecipe()">Copy</button>
      <button class="btn subtle" onclick="shareRecipe()">Share</button>
      <button class="btn subtle" onclick="print()">Print</button>
      <button class="btn subtle" onclick="exportJSON()">Export JSON</button>
      <button class="btn alt hide" id="installBtn" onclick="installApp()">Install App</button>
    </div>

    <!-- targets -->
    <div class="row">
      <div>
        <label for="targetOils">Desired total oils (g)</label>
        <input id="targetOils" type="number" inputmode="decimal" value="1000">
        <div class="note">Enter 750 • 1000 • 1400 etc. (grams)</div>
      </div>
      <div>
        <label for="profile">Recipe profile</label>
        <select id="profile">
          <option value="PF45-30-15-10">Palm-Free Balanced (45/30/15/10)</option>
          <option value="hard40">Hard & long-lasting (Lard/OO)</option>
          <option value="bubbles">Bubbly (higher Coconut/Castor)</option>
        </select>
        <div class="controls"><button class="btn subtle" onclick="applyProfile()">Apply profile</button></div>
      </div>
    </div>

    <!-- use-what-you-have -->
    <section class="card" style="border:1px dashed var(--line)">
      <div class="section-title"><h3 style="margin:0">Use what you have</h3><span class="note">Check oils on hand → suggest a safe blend</span></div>
      <div class="row">
        <div>
          <label>Available oils (tick all that apply)</label>
          <div id="uwhyList" class="kpi"></div>
        </div>
        <div style="align-self:end">
          <button class="btn subtle" onclick="suggestBlend()">Suggest blend</button>
        </div>
      </div>
      <blockquote class="tip">Heuristic: balances hardness, conditioning, bubbly/creamy. You can still tweak in the Oils table.</blockquote>
    </section>

    <!-- oil editor -->
    <fieldset>
      <legend>Oils & Butters</legend>
      <div class="controls">
        <button class="btn subtle" onclick="addOilRow()">+ Add oil</button>
        <button class="btn subtle" onclick="togglePctMode()" id="pctBtn">Percent mode: Off</button>
        <button class="btn subtle" onclick="scaleToTarget()">Scale to target</button>
      </div>
      <table class="table" id="oilTable">
        <thead><tr><th>Oil</th><th style="width:160px"><span id="wtHdr">Weight (g)</span></th><th></th></tr></thead>
        <tbody id="oilBody"></tbody>
      </table>
      <div class="kpi" id="oilTotals"></div>
    </fieldset>

    <!-- lye/water -->
    <fieldset class="grid">
      <legend>Lye & Water</legend>
      <div class="row3">
        <div>
          <label for="lyeType">Lye type</label>
          <select id="lyeType">
            <option value="NaOH">NaOH (bar soap)</option>
            <option value="KOH">KOH (liquid soap)</option>
            <option value="dual">Dual-lye (split)</option>
          </select>
        </div>
        <div>
          <label for="lyePurity">NaOH purity (%)</label>
          <input id="lyePurity" type="number" value="100">
        </div>
        <div>
          <label for="kohPurity">KOH purity (%)</label>
          <input id="kohPurity" type="number" value="90">
        </div>
      </div>
      <div class="row3" id="dualBox" class="hide">
        <div>
          <label for="dualPct">Dual-lye: % as NaOH (rest KOH)</label>
          <input id="dualPct" type="number" value="90">
        </div>
        <div>
          <label for="superfat">Superfat / Lye discount (%)</label>
          <input id="superfat" type="number" value="5">
        </div>
        <div class="note" style="align-self:end">Beginner tip: 3–8% is common.</div>
      </div>
      <div class="row3">
        <div>
          <label for="waterMode">Water mode</label>
          <select id="waterMode">
            <option value="ratio">Water : Lye ratio</option>
            <option value="pctOil">Water % of oils</option>
            <option value="pctSoln">Lye solution % (conc)</option>
            <option value="master">Master-batch lye (%)</option>
          </select>
        </div>
        <div>
          <label for="waterParam" id="waterParamLbl">Water : Lye</label>
          <input id="waterParam" type="number" step="0.05" value="2.5">
        </div>
        <div>
          <label for="milkPct">Milk replacement (% of liquid)</label>
          <input id="milkPct" type="number" value="0">
          <div class="note">Freeze slushy; keep solution cool to avoid scorching.</div>
        </div>
      </div>

      <!-- Fragrance Advisor -->
      <section class="card" style="border:1px dashed var(--line)">
        <div class="section-title"><h3 style="margin:0">Fragrance Advisor</h3><span class="note">Simple guardrails (soap category)</span></div>
        <div class="row3">
          <div>
            <label for="fragType">Type</label>
            <select id="fragType">
              <option value="FO">Fragrance Oil (FO)</option>
              <option value="EO">Essential Oil (EO)</option>
            </select>
          </div>
          <div>
            <label for="fragName">Scent name (optional)</label>
            <input id="fragName" placeholder="e.g., Cinnamon, Lemon, Lavender">
          </div>
          <div>
            <label for="fragPct">Fragrance / EO % of oils</label>
            <input id="fragPct" type="number" value="3" step="0.1">
          </div>
        </div>
        <div class="kpi" id="fragBadges"></div>
      </section>

      <div class="row3">
        <div><label for="potMl">Pot / Crockpot capacity (mL)</label><input id="potMl" type="number" value="5678"></div>
        <div><label for="moldPreset">Mold helper</label>
          <select id="moldPreset" onchange="setMold()">
            <option value="">— choose —</option>
            <option value="loaf">Loaf (L×W×H cm)</option>
            <option value="cavity">Cavity (mL × count)</option>
            <option value="slab">Slab (L×W×H cm)</option>
          </select>
        </div>
        <div class="note" style="align-self:end">Safe headroom: usually 60–75% fill.</div>
      </div>
      <div id="moldInputs" class="row3 hide">
        <div><label>L (cm)</label><input id="mL" type="number"></div>
        <div><label>W (cm)</label><input id="mW" type="number"></div>
        <div><label>H (cm)</label><input id="mH" type="number"></div>
        <div><label>Cavity mL</label><input id="cavMl" type="number"></div>
        <div><label>Cavities</label><input id="cavCount" type="number"></div>
        <div style="align-self:end"><button class="btn subtle" onclick="estimateFromMold()">Estimate oils from mold</button></div>
      </div>
    </fieldset>

    <!-- additives -->
    <fieldset>
      <legend>Additives (% of oils unless noted)</legend>
      <div class="row3">
        <div><label for="slPct">Sodium Lactate % (in water)</label><input id="slPct" type="number" value="0" placeholder="1–3"></div>
        <div><label for="saltPct">Salt %</label><input id="saltPct" type="number" value="0" placeholder="0–3"></div>
        <div><label for="sugarPct">Sugar %</label><input id="sugarPct" type="number" value="0" placeholder="0–3"></div>
      </div>
      <div class="row3">
        <div><label for="clayPct">Clay %</label><input id="clayPct" type="number" value="0" placeholder="0–2"></div>
        <div><label for="chelPct">EDTA/Citrate %</label><input id="chelPct" type="number" value="0.3" step="0.1"></div>
        <div class="note" style="align-self:end">Add “honey” or “aloe” by % in notes (future field coming).</div>
      </div>
      <div class="kpi" id="additiveBadges"></div>
    </fieldset>

    <div class="controls stickyCalc">
      <button class="btn" onclick="calculate()">Calculate</button>
      <button class="btn subtle" onclick="print()">Print</button>
      <button class="btn subtle" onclick="exportJSON()">Export JSON</button>
    </div>

    <!-- results -->
    <section class="card" id="results" style="border:1px dashed #eee">
      <h3 style="margin:6px 0 10px">Batch Results</h3>
      <div class="grid">
        <table class="table" id="resTable"></table>
        <div class="kpi" id="safetyBadges"></div>
      </div>
      <div style="margin-top:8px">
        <details>
          <summary><b>INCI ingredients (for label)</b></summary>
          <div id="inciList" class="note"></div>
        </details>
      </div>
    </section>
  </section>

  <!-- DESIGN HELPER -->
  <section class="card grid hide" id="design" role="tabpanel">
    <h2 style="margin:0">Design Helper</h2>

    <fieldset class="card" style="border:1px dashed var(--line)">
      <legend>Layer Planner</legend>
      <div class="row3">
        <div><label>Layers</label><select id="layCount"><option>2</option><option selected>3</option><option>4</option><option>5</option></select></div>
        <div><label>Split</label><select id="laySplit"><option value="equal" selected>Equal</option><option value="custom">Custom %</option></select></div>
        <div><label>Trace target</label><select id="layTrace"><option>Emulsion</option><option selected>Light</option><option>Medium</option></select></div>
      </div>
      <div id="layPctWrap" class="row hide"></div>
      <div class="controls"><button class="btn subtle" onclick="planLayers()">Plan layers</button></div>
      <table class="table" id="layTable"></table>
      <blockquote class="tip">Workflow: bring entire batch to **emulsion/light trace**, split into bowls by layer %, color/scent each bowl, pour layers (wait ~3–8 min between if you want clean lines).</blockquote>
    </fieldset>

    <fieldset class="card" style="border:1px dashed var(--line)">
      <legend>Swirl Tips</legend>
      <div class="row3">
        <div><label>Technique</label><select id="swirlType"><option>In-the-Pot (ITP)</option><option>Drop Swirl</option><option>Hanger Swirl</option></select></div>
        <div><label>Recommended trace</label><input id="swirlTrace" value="Light to medium"></div>
        <div><label>Notes</label><input id="swirlNotes" value="Color 2–4 portions; pour high for drop; tool for hanger."></div>
      </div>
      <div class="note">These are reminders; the calculator amounts don’t change for swirls (you just split and color). Timing depends on recipe + temp + fragrance behavior.</div>
    </fieldset>
  </section>

  <!-- LYE-LIMITED -->
  <section class="card grid hide" id="lyelimited" role="tabpanel">
    <h2 style="margin:0">Lye-Limited Mode</h2>
    <div class="row3">
      <div><label for="availLye">How much NaOH (g) do you have?</label><input id="availLye" type="number" value="200"></div>
      <div><label for="sfLL">Superfat (%)</label><input id="sfLL" type="number" value="5"></div>
      <div><label for="ratioLL">Water : Lye</label><input id="ratioLL" type="number" value="2.5" step="0.05"></div>
    </div>
    <div class="note">Pick a profile; we’ll auto-proportion oils to the maximum safe total from your available lye.</div>
    <div class="row">
      <div>
        <label for="profileLL">Profile</label>
        <select id="profileLL">
          <option value="PF45-30-15-10">Palm-Free Balanced</option>
          <option value="hard40">Hard & long-lasting</option>
          <option value="bubbles">Bubbly</option>
        </select>
      </div>
      <div style="align-self:end"><button class="btn" onclick="calcLyeLimited()">Calculate from lye</button></div>
    </div>
    <table class="table" id="llRes"></table>
  </section>

  <!-- COST -->
  <section class="card grid hide" id="cost" role="tabpanel">
    <h2 style="margin:0">Cost & Profit</h2>
    <div id="costWrap" class="grid"></div>
    <div class="row3">
      <div><label>Bars per loaf</label><input id="barsCount" type="number" value="10"></div>
      <div><label>Target price per bar ($)</label><input id="priceBar" type="number" value="6" step="0.1"></div>
      <div style="align-self:end"><button class="btn subtle" onclick="calcCost()">Update costs</button></div>
    </div>
    <div class="kpi" id="costSummary"></div>
  </section>

  <!-- SAVE/LOAD -->
  <section class="card grid hide" id="save" role="tabpanel">
    <h2 style="margin:0">Save / Load</h2>
    <div class="row">
      <div><label>Recipe name</label><input id="recName" placeholder="e.g., Charcoal Mint CP"></div>
      <div style="align-self:end" class="controls">
        <button class="btn" onclick="saveRecipe()">Save</button>
        <button class="btn subtle" onclick="loadRecipe()">Load</button>
        <button class="btn subtle" onclick="listRecipes()">List</button>
        <button class="btn subtle" onclick="deleteRecipe()">Delete</button>
      </div>
    </div>
    <div id="saveList" class="kpi"></div>
  </section>

</div>

<script>
/* ========= DATA ========= */
const SAP_NaOH = { // g NaOH per g oil
  "Olive Oil (pure)":0.134, "Coconut Oil 76°":0.183, "Avocado Oil":0.133,
  "Lard":0.141, "Shea Butter (raw)":0.128, "Castor Oil":0.128
};
const OILS = Object.keys(SAP_NaOH);
const INCI = {
  "Olive Oil (pure)":"Olea Europaea (Olive) Fruit Oil",
  "Coconut Oil 76°":"Cocos Nucifera (Coconut) Oil",
  "Avocado Oil":"Persea Gratissima (Avocado) Oil",
  "Lard":"Lard",
  "Shea Butter (raw)":"Butyrospermum Parkii (Shea) Butter",
  "Castor Oil":"Ricinus Communis (Castor) Seed Oil"
};
const KOH_FACTOR = 1.403; // KOH SAP ≈ NaOH SAP * 1.403

const defaults = {
  oils: [["Olive Oil (pure)",450],["Coconut Oil 76°",300],["Lard",150],["Shea Butter (raw)",70],["Castor Oil",30]],
  potMl:5678
};
const additivesSpec = {
  frag:{min:0,max:4.5}, sl:{min:0,max:3}, salt:{min:0,max:3},
  sugar:{min:0,max:3}, clay:{min:0,max:2}, chel:{min:0,max:0.5}
};
let percentMode=false;

/* ========= HELPERS ========= */
const $=s=>document.querySelector(s);
function badge(level,text){const c=level==="ok"?"b-ok":level==="warn"?"b-warn":"b-danger";return `<span class="badge ${c}">${text}</span>`;}
function oilRows(){return [...$("#oilBody").children].map(tr=>[tr.querySelector("select").value, parseFloat(tr.querySelector("input").value||0)]);}
function sum(arr){return arr.reduce((s,x)=>s+x,0)}
function cssId(n){return n.replace(/[^a-z0-9]/gi,'_')}
function gramsToOz(g){return g/28.3495}

/* ========= UI BUILD ========= */
function addOilRow(name="", val=0){
  const tr=document.createElement("tr");
  tr.innerHTML = `
    <td><select>${OILS.map(k=>`<option ${k===name?'selected':''}>${k}</option>`).join('')}</select></td>
    <td><input type="number" value="${val||''}" inputmode="decimal"></td>
    <td><button class="btn subtle" onclick="this.closest('tr').remove();updateOilTotals()">Remove</button></td>`;
  $("#oilBody").appendChild(tr); updateOilTotals();
}
function updateOilTotals(){
  const rows=oilRows();
  let total = sum(rows.map(([_,v])=>v||0));
  if(percentMode){ $("#oilTotals").innerHTML=`<div>Total %: <b>${total.toFixed(1)}%</b> (target ${$("#targetOils").value} g)</div>`; }
  else $("#oilTotals").innerHTML=`<div>Total oils: <b>${total.toFixed(1)} g</b> (${gramsToOz(total).toFixed(2)} oz)</div>`;
}
function applyProfile(){
  const tgt=+$("#targetOils").value||0;
  const p=$("#profile").value;
  const plan = p==="hard40" ? [["Olive Oil (pure)",40],["Lard",40],["Coconut Oil 76°",15],["Castor Oil",5]]
             : p==="bubbles"? [["Olive Oil (pure)",35],["Coconut Oil 76°",35],["Lard",20],["Castor Oil",10]]
             : [["Olive Oil (pure)",45],["Coconut Oil 76°",30],["Lard",15],["Shea Butter (raw)",10]];
  $("#oilBody").innerHTML="";
  if(percentMode){
    plan.forEach(([k,pct])=>addOilRow(k,pct));
  }else{
    let used=0;
    plan.forEach(([k,pct],i)=>{
      const g = i===plan.length-1 ? (tgt-used) : Math.round(tgt*pct/100);
      used+=g; addOilRow(k,g);
    });
  }
  updateOilTotals();
}
function togglePctMode(){
  percentMode = !percentMode;
  $("#wtHdr").textContent = percentMode?"Percent (%)":"Weight (g)";
  $("#pctBtn").textContent = `Percent mode: ${percentMode?'On':'Off'}`;
  updateOilTotals();
}
function scaleToTarget(){
  const tgt=+$("#targetOils").value||0;
  let rows=oilRows();
  if(percentMode){
    const sumPct = sum(rows.map(r=>r[1]||0))||100;
    $("#oilBody").innerHTML="";
    rows.forEach(([name,pct],i)=>{
      const grams = i===rows.length-1 ? (tgt - sum(rows.slice(0,-1).map(([n,p])=>Math.round(tgt*(p/sumPct))))) : Math.round(tgt*(pct/sumPct));
      addOilRow(name, grams);
    });
  }else{
    const curr = sum(rows.map(r=>r[1]||0))||1;
    const factor = tgt/curr;
    $("#oilBody").innerHTML="";
